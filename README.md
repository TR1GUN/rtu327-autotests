# Проект автотестов для RTU-327
 
- старая версия отдельно залита на отдельную ветку, а так же присутствует здесь, однако описание актуально только для новой версии тестов - ЭТО ВАЖНО

**В наличие автотесты для команд:**

- `GETVERSION` - Запрос версии
- `GETTIME` - Запрос текущего времени
- `SETTIME` - Коррекция времени

- `GETSHPRM` - Запрос параметров счетчика

- `GETPOK` - Запрос расчетных показаний счетчика на указанное время

- `GETLP` - Запрос коммерческого профиля нагрузки
- `GETTESTS` - Запрос параметров эл-сети
- `GETAUTOREAD` - Запрос таблицы авточтений
- `GETMTRLOG` - Запрос журнала событий по счетчику

## Зависимости:

 - Все зависимости прописаны в файле requirements.txt, и должны подтягиваться автоматически, а именно : 
   - Библиотека проткола RTU 
   - NumPy Версия 1.16.4
   - для работы автотестов необходимо SSH соединение и наличие библиотеки paramiko (Пока не добавлена в автозагрузку , необходимо ставить самому ручками)
 - Так же для запуска тестов через Pytest понадобится эта библиотека 

# ЗАПУСК

## Необходимые настройки:

Перед запуском необходимо задать правильные параметры в uspd_settings.ini
 
- `uspd_password` - Пароль от УСПД - по умолчанию 00000000
- `ip_address` - IP адрес для соединения
- `ip_port` - порт для соединения
- `ssh_port` - порт для SSH
- `user_login` - логин пользователя в Unix системе (Должен быть администратором) smart
- `user_password` - пароль от этой учетной записи 

## ЗАПУСК ТЕСТОВ со своими значениями

Есть возможность запустить тестовые функции со своими значениями:


**Тестовые функции для сервисных команд :** 
- Файл : `command_service.py`
    - ***command_GETVERSION()*** - Тест для команды - 'GETVERSION' - Запрос версии
         - параметры не нужны 
    - ***command_GETTIME()*** - Тест для команды - 'GETTIME' - Запрос текущего времени
      - параметры не нужны 
      
    - ***command_SETTIME()*** - Тест для команды - 'SETTIME' - Коррекция времени.
 Необходимые переменные: 
      - Обязательный параметр `time_correct` - Время корекции - **int** - положительные и отрицательные числа

- Файл : `command_GETSHPRM.py`
    - ***command_GETSHPRM()*** - Тест для команды - 'GETSHPRM' - Запрос параметров счетчика
      - параметры не нужны 
   
- Файл :  `command_GETPOK.py`
    - ***command_GETPOK()*** - Тест для команды - 'GETPOK' - Запрос расчетных показаний счетчика на указанное время
        - параметр `Ap`: **bool** - Наличие в ответе поля A+ 
        - параметр `Am`: **bool** - Наличие в ответе поля A-
        - параметр `Rp`: **bool** - Наличие в ответе поля R+
        - параметр `Rm`: **bool** - Наличие в ответе поля R-
        - параметр `count_timestamp`: **int** - Количество запрашиваемых записей
        - параметр `RecordTypeId`: **list** - генерируемый тип данных — Поддерживаются значения: 'ElMomentEnergy', 'ElDayEnergy', 'ElMonthEnergy'
   
    

- Файл :  `command_GETLP.py`

    - ***command_GETPOK()*** - Тест для команды - 'GETLP' - Запрос коммерческого профиля нагрузки
        - параметр `Qp`: **bool** - Наличие в ответе поля Q+ 
        - параметр `Qm`: **bool** - Наличие в ответе поля Q-
        - параметр `Pp`: **bool** - Наличие в ответе поля P+
        - параметр `Pm`: **bool** - Наличие в ответе поля P- 
        - параметр `Kk`: **int** - Количество запрашиваемых записей
        - параметр `cTime`: **int** - Время интегрирования (Временно вырезан) 
 


- Файл :  `command_GETTESTS.py`
    - ***command_GETTESTS()*** - Тест для команды - 'GETTESTS' - Запрос параметров эл-сети
        - параметр `NumTests`: **int** - количество запрашиваемых записей

- Файл :  `command_GETAUTOREAD.py`
    - ***command_GETAUTOREAD()*** - Тест для команды - 'GETAUTOREAD' - Запрос таблицы авточтений
        - параметр `Kanal`: **str/int** - тип запрашиваемой энергии — Поддерживаются значения: 'Rm', 4 ,'Rp', 3 ,'Am',  2, 'Ap', 1

- Файл: `command_GETMTRLOG.py`
    - ***command_GETMTRLOG()*** - Тест для команды - 'GETMTRLOG' - Запрос журнала событий по счетчику
        - параметр `RecordTypeId`: **list** - Генерируемый тип журнала — Поддерживаются значения:"ElJrnlPwr", "ElJrnlTimeCorr", "ElJrnlReset", "ElJrnlOpen",
                       "ElJrnlPwrA", "ElJrnlPwrB", "ElJrnlPwrC"
        - параметр `count_timestamp`: **int** - количество тайм штампов для генерации КАЖДОГО типа журналов


    

## ЗАПУСК ТЕСТОВ ЧЕРЕЗ PyTest

- Все тестовые функции так же добавлены в файл *test_castrom_set.py* для запуска через Pytest. 
Для каждой тестовой функции есть свой набор переменных который можно изменять.
  
Набор переменных представлен в виде списка словарей.
Ключ словаря — Имя переменной

Например: 
```
    {
        'Qp': False,
        'Qm': False,
        'Pp': True,
        'Pm': True,
        'Kk': 100,
    },
```
Для добавления нового набора переменных необходимо добавить в список еще один словарь


## Как это работает 

При запуске функции сначала генерируется в Бд необходимые записи: соответственно для каждого прогона теста имеется своя запись Device ID.
После чего, формируется команда на запрос нужного значения, и формирование предполагаемого ответа. 
После получения ответа от RTU идет проверка корректности отправленного пакета: соответствие поля длины, сервисных байтов и корректности полученной CRC относительно ПОЛУЧЕНОГО ПАКЕТА.

Далее идет расшифровка поля DATA полученного пакета согласно протоколу и проверяется с предполагаемыми данными.
Далее идет проверка корректности всех элементов пакета побайтово 

Сравнение побайтово CRC и поля Data - Вырезано - из-за проблем с float
